# Streak System Implementation

## Overview
The streak system encourages daily user engagement by tracking consecutive days of activity. Users can maintain their streak through two different methods:

1. **Create 1 Post** per day (first post of the day counts)
2. **Comment on 5 other users' posts** per day (comments on own posts don't count)

## Key Features

### ‚úÖ **Implemented Features**

1. **Dual Path Streak System**
   - 1 post OR 5 comments on others' posts = 1 streak day
   - First post of the day immediately completes the streak
   - Comments only count on other users' posts (not own posts)

2. **Automatic Reset Logic**
   - Streak resets to 0 if no activity on previous day
   - Daily counters reset at midnight (00:00)
   - Highest streak is always preserved

3. **Real-time Updates**
   - Live streak count in home screen header
   - Real-time updates in streak page
   - Instant feedback when posting/commenting

4. **Progress Tracking**
   - Shows daily progress for both paths
   - Visual indicators for completion status
   - Comments progress: X/5 with progress bar

5. **Leaderboard**
   - Shows top 5 users by current streak
   - Displays both current and highest streaks
   - Simple number-based ranking (1, 2, 3...)

## Database Schema

### Streaks Table
```sql
CREATE TABLE public.streaks (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    current_streak INTEGER DEFAULT 0 NOT NULL,
    highest_streak INTEGER DEFAULT 0 NOT NULL,
    last_activity_date DATE,
    daily_comments_count INTEGER DEFAULT 0 NOT NULL,
    daily_posts_count INTEGER DEFAULT 0 NOT NULL,
    streak_completed_today BOOLEAN DEFAULT FALSE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE(user_id)
);
```

## API Functions

### Core Functions

1. **`updateStreakForPost(userId)`**
   - Called when user creates a post
   - Increments streak if it's the first post of the day
   - Returns streak status and increment info

2. **`updateStreakForComment(userId, postOwnerId)`**
   - Called when user comments on another user's post
   - Increments comment count and checks for streak completion
   - Ignores comments on own posts

3. **`getUserStreak(userId)`**
   - Fetches current streak data
   - Handles automatic reset if needed
   - Returns complete streak information

4. **`getTodayProgress(userId)`**
   - Gets daily progress for both paths
   - Shows how many comments/posts made today
   - Indicates if streak is completed

## Implementation Details

### Post Creation Flow
```javascript
// In createpost.jsx
const streakResult = await updateStreakForPost(user.uid);

if (streakResult.streakIncreased) {
  Alert.alert('üî• Streak Increased!', 
    `Your streak is now ${streakResult.current_streak} days!`);
}
```

### Comment Creation Flow
```javascript
// In postDetailView.jsx
const streakResult = await updateStreakForComment(user.uid, post.user_id);

if (streakResult.streakIncreased) {
  Alert.alert('üî• Streak Increased!', 
    `Your streak is now ${streakResult.current_streak} days!`);
}
```

### Real-time Updates
```javascript
// Subscription to streak changes
const unsubscribe = subscribeToStreakChanges(userId, (payload) => {
  setCurrentStreak(payload.new.current_streak);
});
```

## UI Components

### Home Screen Header
- Real-time streak counter with fire icon
- Styled badge showing current streak
- Clickable to navigate to streak page

### Streak Page
- Current streak with fire animation
- Highest streak in separate badge
- Daily progress indicators
- Time remaining countdown
- Leaderboard with simple numbering
- Information card explaining streak rules

### Progress Indicators
- ‚úÖ Post option: Shows if completed (green) or pending
- üí¨ Comment option: Progress bar (X/5) with completion status
- ‚è∞ Time remaining: Countdown to midnight

## Reset Logic

### Automatic Reset
- Function: `reset_inactive_streaks()`
- Runs automatically (can be triggered by cron job)
- Resets streaks for users inactive previous day
- Resets daily counters for new day

### Manual Reset Detection
- Client-side checks on app launch
- Compares last activity date with current date
- Triggers reset if needed before showing data

## Error Handling

### Network Errors
- Graceful fallback for API failures
- Non-blocking streak updates (posts/comments still work)
- Error logging without user disruption

### Edge Cases
- Duplicate requests (idempotent operations)
- Race conditions (proper state management)
- Offline scenarios (cached data)

## Performance Optimizations

### Database Indexes
```sql
CREATE INDEX idx_streaks_user_id ON streaks(user_id);
CREATE INDEX idx_streaks_current_streak ON streaks(current_streak DESC);
CREATE INDEX idx_streaks_highest_streak ON streaks(highest_streak DESC);
```

### Caching Strategy
- Real-time subscriptions for live updates
- Optimistic UI updates
- Minimal database queries

## Future Enhancements

### Potential Features
1. **Streak Rewards** - Badges, points, or achievements
2. **Weekly Challenges** - Special streak goals
3. **Streak Recovery** - One-time streak restore option
4. **Social Features** - Streak sharing, competitions
5. **Analytics** - Streak patterns, engagement insights

## Testing

### Key Test Scenarios
1. Post creation increments streak (first of day)
2. Comment on others' posts counts toward streak
3. Comments on own posts don't count
4. Streak resets after missed day
5. Highest streak is preserved
6. Real-time updates work correctly

## Security

### Row Level Security (RLS)
- Users can only access their own streak data
- Secure function execution with SECURITY DEFINER
- Proper authentication checks

### Data Validation
- Server-side validation of streak logic
- Protection against manipulation
- Rate limiting considerations

---

## Quick Setup Guide

1. **Run Database Migration**
   ```bash
   npx supabase migration up
   ```

2. **Import Streak Functions**
   ```javascript
   import { updateStreakForPost, updateStreakForComment } from '../(apis)/streaks';
   ```

3. **Add to Post Creation**
   ```javascript
   await updateStreakForPost(user.uid);
   ```

4. **Add to Comment Creation**
   ```javascript
   await updateStreakForComment(user.uid, postOwnerId);
   ```

5. **Add Real-time Updates**
   ```javascript
   const unsubscribe = subscribeToStreakChanges(userId, callback);
   ```

The streak system is now fully implemented and ready for production use! 